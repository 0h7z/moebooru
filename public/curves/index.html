<!DOCTYPE html>
<html><head>
<title>Curves</title>

<style type="text/css">
#display-canvas {
    float: right;
}
#curve-editor {
    position: fixed;
    bottom: 0;
    left: 0;
    /* float: left; */
    background-color: #FFFFFF;
    padding: 0.5em 0.5em 0.1em 0.1em;
}

.curve-editor-crop {
    /* This box crops off anything outside of the 251x251 area.  This happens
     * when handles are near the edge. */
    width: 251px;
    height: 251px;
    overflow: hidden;
}

.canvas-box {
    /* The canvas has a one-pixel buffer around it.  Move the box down and the canvas up,
     * so the offset of canvas-box is the top-left of the active part of the canvas, minus
     * the buffer area.  Mouse coordinates are calculated relative to this box. */
    margin: 1px;

    /* Things like handles and drag-axes are positioned relative to this. */
    position: relative;
}

.canvas-box > .curve-canvas {
    /* The outer pixel is a buffer, containing the grid but lying outside of the curve
     * area. */
    margin: -1px;

    /* background-color: #A0A0A0; */
}

.curves-handle-box {
    position: relative;
}

.drag-axes {
    position: absolute;
    pointer-events: none;
}
.drag-axes > .horizontal {
    width: 600px; height: 1px; background-color: #000000; margin-left: -300px;
}
.drag-axes > .vertical {
    height: 600px; width: 1px; background-color: #000000; margin-top: -300px;
}

.curves-handle {
    position: absolute;
    top: 0px;
    left: 0px;
    width: 9px;
    height: 9px;
    margin: -4px;

    width: 29px;
    height: 29px;
    margin: -14px;
}

.curves-handle > .curves-handle-inner {
    margin: 12px;
    width: 3px;
    height: 3px;
    pointer-events: none;
}

/* When hovering over a handle, show the move cursor.  When dragging, the
 * cursor set on the body is used instead. */
.canvas-box:not([dragging]) .curves-handle {
    cursor: move;
}

.curves-handle[dragging] {
    cursor: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjbQg61aAAAADUlEQVQYV2P4//8/IwAI/QL/+TZZdwAAAABJRU5ErkJggg=='), none;
}

body[cursor="none"] {
    cursor: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjbQg61aAAAADUlEQVQYV2P4//8/IwAI/QL/+TZZdwAAAABJRU5ErkJggg=='), none;
}
body[cursor="crosshair"] { cursor: crosshair; }

/*.curves-handle.rgb[selected] { cursor: crosshair; }*/
.curves-handle.rgb > .curves-handle-inner { border: 1px solid black; }
.curves-handle.red > .curves-handle-inner { border: 1px solid #FF0000; }
.curves-handle.green > .curves-handle-inner { border: 1px solid #00FF00; }
.curves-handle.blue > .curves-handle-inner { border: 1px solid #0000FF; }
.curves-handle.rgb[selected] > .curves-handle-inner { background-color: #000000; }
.curves-handle.red[selected] > .curves-handle-inner { background-color: #FF0000; }
.curves-handle.green[selected] > .curves-handle-inner { background-color: #00FF00; }
.curves-handle.blue[selected] > .curves-handle-inner { background-color: #0000FF; }

.point-box:disabled {
    background-color: #FFFFFF;
}

.curve-canvas {
}

.canvas-box[draggablePoint] {
    cursor: crosshair;
}

.curve-editor .left-edge {
    width: 50px;
    height: 251px;
    float: left;
    margin-right: 2px;
    position: relative;
    text-align: right;
}

.curve-reference-vertical
{
    float: left;
    background: -moz-linear-gradient(90deg, #000000, #FFFFFF);
    background: -webkit-gradient(linear, left bottom, left top, from(#000000), to(#FFFFFF));
    height: 251px;
    width: 10px;
    border: 1px solid #000000;
    border-right: none;
}

.curve-horizontal-drag-box
{
    width: 268px;
    height: 22px;
    /* background-color: #FF0000; */ /* uncomment to see the drop zone */
    margin-left: 53px;
}

/* The horizontal gradient.  Note that whem dragging in curve-horizontal-drag-box,
 * the mouse position is calculated relative to this gradient, so the extra drop
 * zone space around the actual box doesn't throw off the position. */
.curve-reference-horizontal
{
    margin-left: 10px;
    background: -moz-linear-gradient(0deg, #000000, #FFFFFF);
    background: -webkit-gradient(linear, left top, right top, from(#000000), to(#FFFFFF));
    height: 10px;
    width: 251px;
    border: 1px solid #000000;
    border-top: none;

    /* The whitepoint/blackpoint sliders are rendered relative to this. */
    position: relative;
}

.horizontal-slider-box {
    position: absolute;
    left: 0px;
}
.horizontal-slider {
    margin-left: -6px;
    margin-top: 11px;
}
/* If we use <input type=file hidden>, click() breaks in Chrome, so we need
 * to hide file inputs without actually causing them to not be rendered. */
.hidden-file-input {
    visibility: hidden;
    left: 0;
    position: absolute;
    pointer-events: none;
}

</style>

<script type="text/javascript" src="common.js" defer></script>
<script type="text/javascript" src="webgl-helpers.js" defer></script>
<script type="text/javascript" src="interpolation.js" defer></script>
<script type="text/javascript" src="draggable.js" defer></script>
<script type="text/javascript" src="renderer.js" defer></script>
<script type="text/javascript" src="histogram.js" defer></script>
<script type="text/javascript" src="glMatrix.js" defer></script>
<script type="text/javascript" src="curve-editor.js" defer></script>
<script type="text/javascript" src="main.js" defer></script>

<script id="shader-fs" type="x-shader/x-fragment">
    precision lowp float;

    varying vec2 vTextureCoord;

    uniform sampler2D uSampler;
    uniform sampler2D uLUTSampler;

    void main(void)
    {
        vec4 inputColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));

        /* Apply the curves for each channel. */
        inputColor.r = texture2D(uLUTSampler, vec2(inputColor.r, 0.0/2.0)).r;
        inputColor.g = texture2D(uLUTSampler, vec2(inputColor.g, 1.0/2.0)).r;
        inputColor.b = texture2D(uLUTSampler, vec2(inputColor.b, 2.0/2.0)).r;

        gl_FragColor = inputColor;
    }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uPMatrix;

    varying vec2 vTextureCoord;

    void main(void)
    {
        gl_Position = uPMatrix * vec4(aVertexPosition, 1.0);
        vTextureCoord = aTextureCoord;
    }
</script>

<script id="histogram-render-fs" type="x-shader/x-fragment">
    precision lowp float;

    varying vec2 vInputPosition;
    uniform sampler2D uSampler;
    uniform vec3 uColor;

    void main(void)
    {
        float level = texture2D(uSampler, vec2(vInputPosition.x, 0.0)).r;
//        level = pow(level, 0.4);
        level = (1.0-level) < vInputPosition.y? 1.0: 0.0;
        gl_FragColor = vec4(uColor, level);
    }
</script>

<script id="histogram-render-vs" type="x-shader/x-vertex">
    attribute vec2 aVertexPosition;

    uniform mat4 uPMatrix;
    varying vec2 vInputPosition;

    void main(void)
    {
        gl_Position = uPMatrix * vec4(aVertexPosition, 0.0, 1.0);
        vInputPosition = aVertexPosition;
    }
</script>


</head>

<body onload="init()">
    <div id="curve-editor">
        <div class="curve-editor">
            <input id="load-file-input" type=file class="hidden-file-input">
            <div id="load-url-box">
                <span style="width: 50px; margin-right: 2px; display: block; float: left; text-align: right;">URL:</span>
                <input id="image-url-box" style="width: 170px;">
                or <a href="#" id="load-file-link">open a file</a>
            </div>

            <div id="load-file-box" hidden>
                <span style="width: 50px; margin-right: 2px; display: block; float: left; text-align: right;">File:</span>
                <a href="#" id="image-filename-box"></a>
                <a href="#" id="load-url-link" style="float: right;">open a URL</a>
            </div>

            <div class="curve-editor-curve-url-box">
                <div class="left-edge">
                    <a class=acv-save href='#'>Save</a>
                    <a class=acv-load href='#'>Load</a>
                    <a class=reset-button href='#'>Reset</a>
                    <input class="acv-load-input hidden-file-input" type=file>
                    <div style="position: absolute; bottom: 0px;">
                        Output: <br> <input class="point-box point-output" style="width: 40px;">
                    </div>
                </div>
                <div class="curve-reference-vertical"></div>

                <!-- This div crops off handles that go too far over the edge of the canvas. -->
                <div class="curve-editor-crop" style="border: 1px solid #000000;">
                    <div class="canvas-box" style="position: relative;">
                        <canvas id="histogram-canvas" width=251 height=251 style="position: absolute; top: 0;"></canvas>
                        <canvas class="curve-canvas" width=251 height=251 style="position: absolute;"></canvas>

                        <!-- This holds the curve handles. -->
                        <div class="curves-handle-box" style="position: absolute;"></div>

                        <!-- The axes displayed when dragging: -->
                        <div class="drag-axes" hidden>
                            <div class="horizontal"></div>
                            <div class="vertical"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="curve-horizontal-drag-box">
                <div class="curve-reference-horizontal">
                    <div class="horizontal-slider-box blackpoint-marker">
                        <svg height=10 width=14 viewBox="-7 0 14 10" class="horizontal-slider horizontal-slider-white" style="color: white;" stroke=#000000>
                            <path d="M 0.5,1 l 4,4 v 2.5 h -8 v -2.5 Z" fill=black />
                        </svg>
                    </div>
                    <div class="horizontal-slider-box whitepoint-marker" style="left: 100px;">
                        <svg height=10 width=14 viewBox="-7 0 14 10" class="horizontal-slider horizontal-slider-white" style="color: white;" stroke=#000000>
                            <path d="M 0.5,1 l 4,4 v 2.5 h -8 v -2.5 Z" fill=white />
                        </svg>
                    </div>
                </div>
            </div>
            
            <div style="display: none;">
                <div class="curves-handle-template curves-handle">
                    <div class="curves-handle-inner">
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-left: 55px;">
            Input: <br> <input class="point-box point-input" size=3>
            <select id="channel-select">
                <option value="M">RGB (Alt-2)</option>
                <option value="R">Red (Alt-3)</option>
                <option value="G">Green (Alt-4)</option>
                <option value="B">Blue (Alt-5)</option>
            </select>
            <input id="show-clipping" type=checkbox>
            <label for=show-clipping>Show clipping</label>
        </div>
    </div>
    <canvas id="display-canvas" width="500" height="500"></canvas>
</body></html>
